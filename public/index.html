<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Фарминг Мини-App</title>
    <style>
        :root {
            --background-color: #121212;
            --card-bg: #1e1e1e;
            --button-bg: #3a3a3a;
            --button-hover-bg: #575757;
            --accent-color: #00d1ff;
            --text-color: #ffffff;
            --subtext-color: #b0b0b0;
            --border-color: #333333;
            --animation-color: #00ffea;
            --popup-bg: rgba(0, 0, 0, 0.8);
            --popup-text: #ffffff;
            --nav-active-bg: #ff4d4d;
            --nav-inactive-border: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--background-color), #1e1e1e);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            position: relative;
            padding-bottom: 60px; /* Для панели навигации */
        }

        .header {
            margin-top: 100px;
            width: 320px;
            height: 160px;
            background: linear-gradient(145deg, var(--card-bg), #2a2a2a);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            position: relative;
            padding: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: background 0.5s;
        }

        .logo {
            width: 25px;
            height: 25px;
            position: absolute;
            top: 15px;
            cursor: pointer;
        }

        .logo1 {
            left: 15px;
            animation: float 6s ease-in-out infinite;
        }

        .logo2 {
            right: 15px;
            animation: float 6s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .balance {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            margin-top: 20px;
            background: linear-gradient(90deg, var(--accent-color), var(--animation-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
        }

        .balance span {
            display: block;
            font-size: 14px;
            color: var(--subtext-color);
            margin-top: 5px;
        }

        .profit-left, .profit-right {
            position: absolute;
            bottom: 15px;
            font-size: 14px;
            color: var(--subtext-color);
        }

        .profit-left {
            left: 15px;
        }

        .profit-right {
            right: 15px;
        }

        .farm-button {
            margin-top: 40px;
            width: 320px;
            padding: 15px;
            background: linear-gradient(135deg, var(--button-bg), #4d4d4d);
            color: var(--text-color);
            border: none;
            border-radius: 15px;
            font-size: 18px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: background 0.3s, transform 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .farm-button:hover {
            background: linear-gradient(135deg, var(--button-hover-bg), #6b6b6b);
            transform: translateY(-2px);
        }

        .farm-button:active {
            transform: translateY(0);
        }

        .farm-button span {
            transition: opacity 0.5s;
            z-index: 1;
            position: relative;
        }

        .farm-button .animation-text,
        .farm-button .animation-number,
        .farm-button .claim-text,
        .farm-button .claim-number {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 1;
        }

        .farm-button .animation-text {
            left: 20px;
            color: var(--animation-color);
            font-weight: bold;
        }

        .farm-button .animation-number {
            right: 20px;
            color: var(--accent-color);
            font-weight: bold;
        }

        .farm-button .claim-text {
            left: 20px;
            color: #ff5722;
            font-weight: bold;
        }

        .farm-button .claim-number {
            right: 20px;
            color: #ffc107;
            font-weight: bold;
        }

        .farm-button.active .animation-text,
        .farm-button.active .animation-number,
        .farm-button.claim-mode .claim-text,
        .farm-button.claim-mode .claim-number {
            opacity: 1;
        }

        /* Gradient Animation */
        @keyframes gradient {
            0% { background-position: 0% }
            50% { background-position: 100% }
            100% { background-position: 0% }
        }

        /* Панель навигации */
        .navbar {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 60px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #444;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--subtext-color);
            cursor: pointer;
            transition: color 0.3s;
        }

        .nav-item.active {
            background: var(--nav-active-bg);
            border-radius: 12px;
            padding: 5px 10px;
            color: var(--text-color);
            /* Дополнительное выделение */
            box-shadow: 0 0 10px var(--nav-active-bg);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
            transition:fill 0.3s;
        }

        .nav-item.active svg {
            fill: var(--text-color);
        }

        .nav-item span {
            font-size: 12px;
            margin-top: 4px;
        }

        /* Всплывающие уведомления */
        .toast {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: var(--popup-bg);
            color: var(--popup-text);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.5s, transform 0.5s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        /* Адаптивный дизайн для полноэкранного режима */
        @media screen and (orientation: landscape) {
            /* Ваши стили для альбомного режима */
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="logo1.png" alt="Logo1" class="logo logo1">
        <img src="logo2.png" alt="Logo2" class="logo logo2">
        <div class="balance">
            <div id="balanceAmount">0</div>
            <span>$NZ</span>
        </div>
        <div class="profit-left">Прибыль в час</div>
        <div class="profit-right">20 per/hour</div>
    </div>
    <button class="farm-button" id="farmButton">
        <span id="buttonText">НАЧАТЬ ФАРМИНГ</span>
        <span class="animation-text">Фарминг...</span>
        <span class="animation-number">0.005/s</span>
        <span class="claim-text">CLAIM</span>
        <span class="claim-number">60</span>
    </button>

    <!-- Панель навигации -->
    <div class="navbar">
        <div class="nav-item active" data-section="friends">
            <!-- Иконка для Друзья -->
            <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5s-3 1.34-3 3 1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            <span>Друзья</span>
        </div>
        <div class="nav-item" data-section="games">
            <!-- Иконка для Игры -->
            <svg viewBox="0 0 24 24"><path d="M21 7H3v10h18V7zm-2 8H5V9h14v6z"/></svg>
            <span>Игры</span>
        </div>
        <div class="nav-item" data-section="home">
            <!-- Иконка для Главная -->
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>Главная</span>
        </div>
        <div class="nav-item" data-section="tasks">
            <!-- Иконка для Задания -->
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14l4-4h12c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
            <span>Задания</span>
        </div>
        <div class="nav-item" data-section="exchange">
            <!-- Иконка для Обмен -->
            <svg viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v4h2V5h10v14h-4v2h6V5c0-1.1-.9-2-2-2z"/></svg>
            <span>Обмен</span>
        </div>
    </div>

    <!-- Всплывающее уведомление -->
    <div id="toast" class="toast"></div>

    <!-- Подключение Telegram Web App API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const farmButton = document.getElementById('farmButton');
        const buttonText = document.getElementById('buttonText');
        const balanceAmount = document.getElementById('balanceAmount');
        const toast = document.getElementById('toast');
        const navItems = document.querySelectorAll('.nav-item');

let farming = false;
let balance = 0;
let farmingInterval;
let farmingDuration = 3 * 60 * 60 * 1000; // 3 часа
let farmingStartTime;
let farmingTimeout;
let accumulated = 0;
let claimMode = false;

// Telegram WebApp объект
const telegram = window.Telegram.WebApp;

// Запросить данные пользователя из бота
const initData = telegram.initDataUnsafe;

// Функция для отображения уведомлений
function showToast(message) {
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 4000);
}

// Функция для обновления интерфейса на основе состояния
function updateInterface(data) {
    balance = parseFloat(data.balance) || 0;
    balanceAmount.textContent = balance.toFixed(3);

    if (data.farming) {
        farming = true;
        farmingStartTime = new Date(data.farmingStartTime);
        startFarmingInterval();
        farmButton.classList.add('active');
        buttonText.style.opacity = 0;
    } else if (data.claimMode) {
        claimMode = true;
        farmButton.classList.add('claim-mode');
        document.querySelector('.claim-number').textContent = data.accumulated.toFixed(3);
        buttonText.textContent = '';
    } else {
        farming = false;
        claimMode = false;
        farmButton.classList.remove('active');
        farmButton.classList.remove('claim-mode');
        buttonText.textContent = 'НАЧАТЬ ФАРМИНГ';
    }
}

// Инициализация приложения
async function initApp() {
    try {
        const response = await fetch('/api/user-state', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                telegramId: initData.user.id,
            }),
        });
        const data = await response.json();
        if (data.success) {
            updateInterface(data.user);
            if (data.user.farming) {
                // Рассчитать оставшееся время
                const elapsed = Date.now() - new Date(data.user.farmingStartTime).getTime();
                if (elapsed < farmingDuration) {
                    farmingTimeout = setTimeout(stopFarming, farmingDuration - elapsed);
                } else {
                    stopFarming();
                }
            }
        } else {
            showToast('Ошибка при инициализации данных.');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        showToast('Произошла ошибка при инициализации приложения.');
    }
}

// Запуск фарминга
farmButton.addEventListener('click', async () => {
    if (!farming && !claimMode) {
        startFarming();
    } else if (claimMode) {
        await claimRewards();
    }
});

function startFarming() {
    farming = true;
    farmingStartTime = new Date();
    farmButton.classList.add('active');
    buttonText.style.opacity = 0;
    startFarmingInterval();

    // Отправить запрос на сервер о запуске фарминга
    fetch('/api/start-farming', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    telegramId: initData.user.id,
                    farmingStartTime: farmingStartTime,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Фарминг начат!');
                    farmingTimeout = setTimeout(stopFarming, farmingDuration);
                } else {
                    showToast('Не удалось начать фарминг.');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Произошла ошибка при запуске фарминга.');
            });
        }

        function startFarmingInterval() {
            farmingInterval = setInterval(() => {
                const now = Date.now();
                const elapsed = now - farmingStartTime.getTime();
                balance += 0.005;
                accumulated += 0.005;
                balanceAmount.textContent = balance.toFixed(3);
            }, 1000);
        }

        function stopFarming() {
            farming = false;
            clearInterval(farmingInterval);
            farmButton.classList.remove('active');
            farmButton.classList.add('claim-mode');
            buttonText.textContent = '';
            document.querySelector('.claim-number').textContent = accumulated.toFixed(3);

            // Отправить запрос на сервер о завершении фарминга
            fetch('/api/stop-farming', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    telegramId: initData.user.id,
                    accumulated: accumulated,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Фарминг закончен! Можете забрать награду.');
                } else {
                    showToast('Не удалось завершить фарминг.');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showToast('Произошла ошибка при завершении фарминга.');
            });
        }

        async function claimRewards() {
            // Отправить запрос на сервер о выводе средств
            try {
                const response = await fetch('/api/claim', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegramId: initData.user.id,
                        claim: accumulated,
                    }),
                });
                const data = await response.json();
                if (data.success) {
                    showToast(`Вы забрали ${accumulated.toFixed(3)} $NZ!`);
                    balance += accumulated;
                    balanceAmount.textContent = balance.toFixed(3);
                    accumulated = 0;
                    farmButton.classList.remove('claim-mode');
                    buttonText.textContent = 'НАЧАТЬ ФАРМИНГ';
                } else {
                    showToast(data.message || 'Не удалось забрать награду.');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showToast('Произошла ошибка при выводе награды.');
            }
        }

        // Панель навигации
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                // Действия при выборе раздела
                const section = item.getAttribute('data-section');
                showSection(section);
            });
        });

        function showSection(section) {
            // Здесь можно реализовать переключение между разделами
            showToast(`Перешли в раздел: ${section}`);
        }

        // Полноэкранный режим
        function enterFullscreen() {
            telegram.requestFullscreen();
        }

        // Включить полноэкранный режим при загрузке
        window.addEventListener('load', () => {
            initApp();
            enterFullscreen();
        });

        // Закрыть полноэкранный режим при выходе из приложения
        telegram.onEvent('visibilityChanged', () => {
            if (!telegram.isVisible) {
                telegram.exitFullscreen();
            }
        });

    </script>
</body>
</html>
